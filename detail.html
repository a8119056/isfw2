<!DOCTYPE html>

<html style="overflow: auto;">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/osql.js"></script>
    <title>投稿詳細 | 動画共有SNS</title>
</head>

<body id="body" class="bg-light" style="overflow-x : hidden;">
    <header class="m-3">
        <h1>投稿詳細</h1>
        <div class="m-1">
            <a href="usertop.html" class="btn btn-primary">トップページへ</a>
            <a href="javascript:history.back()" class="btn btn-secondary ms-1">もどる</a>
        </div>
    </header>
    <hr>
    <div class="container m-2">
        <div id="video" class="me-3"></div>
        <div id="post-comment" class="mt-4">
            <h3>コメントする</h3>
            <p id="comment-result"><br></p>
        </div>
        <input id="input-comment" class="form-control"><button type="button" class="btn btn-success mt-3" onclick="postComment()">投稿</button>
    </div>
    </div>
    <hr>
    <div class="container m-2">
        <div id="comment-buttons"></div>
        <div id="comments"></div>
    </div>
    <hr>
    <footer>
        <div class="text-center p-4">
            <p>&copy; 2021 AEON SOFT Ltd.<br>All rights reserved.</p>
        </div>
    </footer>
</body>

<script>
    $(function() {
        checkLogin();
    });

    async function checkLogin() {
        osql.requireLogin();
        var userid = sessionStorage.getItem("userid");
        if (!userid) {
            location.href = "index.html";
        } else {
            countComments();
            doSelect();
        }
    }

    var reply_nums;

    async function countComments() {
        var sql = `select count(*) as count from Comments;`;
        var objects = await osql.connect(sql);
        var object = objects[0];
        reply_nums = [...Array(Number(object.count)).keys()];
    }

    async function doSelect() {
        var element = document.getElementById("video");
        var width = parseInt(window.getComputedStyle(element).width);
        if (width > 736) {
            width = 736;
        }
        var height = Math.round(width * 9 / 16);

        var userid = sessionStorage.getItem("userid");
        var videoid = osql.getParam("videoid");
        var sql = `select Videos.id as videoid, url, note, good, bad, name from Videos inner join Users on Videos.userid = Users.id where Videos.id = ${videoid};`;
        var objects = await osql.connect(sql);
        var object = objects[0];

        var count_sql = `select Videos.id from (Videos inner join Users on Videos.userid = Users.id) left join Comments on Videos.id = Comments.toid where Comments.toid = ${videoid} and !is_to_comment;`;
        var counts = await osql.connect(count_sql);
        if (counts.length > 0) {
            document.getElementById("video").innerHTML = `<iframe width='${width}' height='${height}' src='https://www.youtube.com/embed/${object.url}' title='YouTube video player' frameborder='0' allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture' allowfullscreen></iframe><div id="user" class="mb-3"></div><div id="review"></div>`;
            document.getElementById("comment-buttons").innerHTML = `<button id="comment-close" type="button" class="btn btn-primary" onclick="closeComments()">コメントを非表示</button><button id="comment-open" type="button" class="btn btn-primary" style="display:none;" onclick="openComments()">コメントを表示</button>`;
            selectComments();
        } else {
            document.getElementById("video").innerHTML = `<iframe width='${width}' height='${height}' src='https://www.youtube.com/embed/${object.url}' title='YouTube video player' frameborder='0' allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture' allowfullscreen></iframe><div id="user" class="mb-3"></div><div id="review"></div>`;
            document.getElementById("comments").innerHTML = "まだコメントはありません";
        }

        document.getElementById("user").innerHTML = `<a href="profile.html?userid=${userid}" class="btn btn-sm btn-outline-dark fs-5 mt-3 mb-2">${object.name}</a><p class="my-3">${object.note}</p>`;
        if (userid === object.userid) {
            document.getElementById("user").innerHTML += `<button type="button" class="btn btn-sm btn-primary" onclick="editNote('${object.note}')">編集</button>`;
        }
        document.getElementById("review").innerHTML = `<button type="button" class="btn btn-sm btn-outline-secondary" onclick="doVideoGood(${videoid})">👍</button><span class="ms-2">${object.good}</span><button type="button" class="btn btn-sm btn-outline-secondary ms-4" onclick="doVideoBad(${videoid})">👎</button><span class="ms-2">${object.bad}</span>`;
    }


    function editNote(note) {
        var userid = sessionStorage.getItem("userid");
        var username = sessionStorage.getItem("username");
        document.getElementById("user").innerHTML = `<a href="profile.html?userid=${userid}" class="btn btn-sm btn-outline-dark fs-5 mt-3 mb-2">${username}</a><input id="edit-note" class="form-control mt-2" value="${note}"></input><div class="mt-3"><button type="button" class="btn btn-sm btn-primary" onclick="updateNote()">更新</button><button type="button" class="btn btn-sm btn-outline-danger ms-1" onclick="cancelEditNote('${note}')">取消</button></div>`;
    }

    function cancelEditNote(note) {
        var userid = sessionStorage.getItem("userid");
        var username = sessionStorage.getItem("username");
        document.getElementById("user").innerHTML = `<a href="profile.html?userid=${userid}" class="btn btn-sm btn-outline-dark fs-5 mt-3 mb-2">${username}</a><p class="my-3">${note}</p><button type="button" class="btn btn-sm btn-primary" onclick="editNote('${note}')">編集</button>`;
    }

    async function updateNote() {
        var userid = sessionStorage.getItem("userid");
        var username = sessionStorage.getItem("username");
        var videoid = osql.getParam("videoid");
        var new_note = document.getElementById("edit-note").value;
        var sql = `update Videos set note = "${new_note}" where id = ${videoid};`;
        await osql.connect(sql);
        document.getElementById("user").innerHTML = `<a href="profile.html?userid=${userid}" class="btn btn-sm btn-outline-dark fs-5 mt-3 mb-2">${username}</a><p class="my-3">${new_note}</p><button type="button" class="btn btn-sm btn-primary" onclick="editNote('${new_note}')">編集</button>`;
    }

    async function postComment() {
        var userid = sessionStorage.getItem("userid");
        var videoid = osql.getParam("videoid");
        var comment = document.getElementById("input-comment").value;
        var sql = `insert into Comments (userid, comment, toid, is_to_comment) values ("${userid}", "${comment}", ${videoid}, false);`;

        if (comment.length > 0) {
            var count_sql = `select Videos.id from (Videos inner join Users on Videos.userid = Users.id) left join Comments on Videos.id = Comments.toid where Comments.toid = ${videoid} and !is_to_comment;`;
            var counts = await osql.connect(count_sql);
            if (counts.length < 1) {
                document.getElementById("comment-buttons").innerHTML = `<button id="comment-close" type="button" class="btn btn-primary" onclick="closeComments()">コメントを非表示</button><button id="comment-open" type="button" class="btn btn-primary" style="display:none;" onclick="openComments()">コメントを表示</button>`;
            }
            await osql.connect(sql);
            document.getElementById("input-comment").value = "";
            selectComments();
            document.getElementById("comment-result").innerHTML = "投稿しました";
        } else {
            document.getElementById("comment-result").innerHTML = `<span class=text-danger>*</span>投稿失敗: コメントを入力してください`;
        }
    }

    async function selectComments() {
        document.getElementById("comments").innerHTML = "";
        var userid = sessionStorage.getItem("userid");
        var videoid = osql.getParam("videoid");
        var sql = `select name, Comments.id as comment_id, Comments.userid as commenter_id, comment, Comments.good as good, Comments.bad as bad from (Videos left join Comments on Videos.id = Comments.toid) inner join Users on Comments.userid = Users.id where Comments.toid = ${videoid} and !is_to_comment;`;
        var objects = await osql.connect(sql);
        for (let i = 0; i < objects.length; i++) {
            object = objects[i];
            new_reply_num = reply_nums.shift();
            var count_sql = `select Childs.id from (Comments as Parents left join Comments as Childs on Parents.id = Childs.toid) inner join Users on Childs.userid = Users.id where Childs.toid = ${object.comment_id} and Childs.is_to_comment;`;
            var counts = await osql.connect(count_sql);
            if (counts.length > 0) {
                document.getElementById("comments").innerHTML += `<hr><div id="commenter${i}"></div><div id="comment-review${i}"></div><div id="post-reply${new_reply_num}"><p id="reply-result${new_reply_num}" class="mt-3"><br></p><div id="reply-buttons${new_reply_num}"><button type="button" class="btn btn-sm btn-success" onclick="showReplyForm(${object.comment_id}, ${new_reply_num}, true)">返信する</button><button id="reply-select${new_reply_num}" type="button" class="btn btn-sm btn-primary ms-2" onclick="selectReplies(${object.comment_id}, ${new_reply_num})">返信を表示</button></div><div id="replies${new_reply_num}" class="ms-5"></div>`;
                document.getElementById("comment-open").style.display = "none";
            } else {
                document.getElementById("comments").innerHTML += `<hr><div id="commenter${i}"></div><div id="comment-review${i}"></div><div id="post-reply${new_reply_num}"><p id="reply-result${new_reply_num}" class="mt-3"><br></p><div id="reply-buttons${new_reply_num}"><button type="button" class="btn btn-sm btn-success"onclick="showReplyForm(${object.comment_id}, ${new_reply_num}, false)">返信する</button></div><div id="replies${new_reply_num}" class="ms-5"></div>`;
            }
            document.getElementById("commenter" + i).innerHTML = `<a href="profile.html?userid=${object.commenter_id}" class="btn btn-sm btn-outline-dark mt-1 mb-3">${object.name}</a><p class="mb-2">${object.comment}</p>`;
            if (userid === object.commenter_id) {
                document.getElementById("commenter" + i).innerHTML += `<div class="my-3"><button type="button" class="btn btn-sm btn-primary" onclick="editComment('${object.comment}', 'commenter' + ${i}, ${new_reply_num}, ${object.comment_id})">編集</button><button type="button" class="btn btn-sm btn-danger ms-2" onclick="deleteComment(${object.comment_id}, false)">削除</button></div>`;
            }
            document.getElementById("comment-review" + i).innerHTML = `<button type="button" class="btn btn-sm btn-outline-secondary" onclick="doCommentGood(${object.comment_id})">👍</button><span class="ms-2">${object.good}</span><button type="button" class="btn btn-sm btn-outline-secondary ms-4" onclick="doCommentBad(${object.comment_id}, false)">👎</button><span class="ms-2">${object.bad}</span>`;
        }
    }


    function closeComments() {
        document.getElementById("comment-open").style.display = "block";
        document.getElementById("comment-close").style.display = "none";
        document.getElementById("comments").style.display = "none";
    }

    function openComments() {
        document.getElementById("comment-open").style.display = "none";
        document.getElementById("comment-close").style.display = "block";
        document.getElementById("comments").style.display = "block";
    }

    async function selectReplies(toid, reply_num) {
        var userid = sessionStorage.getItem("userid");
        var sql = `select name, Childs.userid as replier_id, Childs.id as reply_id, Childs.comment as comment, Childs.good as good, Childs.bad as bad from (Comments as Parents left join Comments as Childs on Parents.id = Childs.toid) inner join Users on Childs.userid = Users.id where Childs.toid = ${toid} and Childs.is_to_comment;`;
        var objects = await osql.connect(sql);
        for (let i = 0; i < objects.length; i++) {
            object = objects[i];
            new_reply_num = reply_nums.shift();
            var count_sql = `select Childs.id from (Comments as Parents inner join Users on Parents.userid = Users.id) left join Comments as Childs on Parents.id = Childs.toid where Childs.toid = ${object.reply_id} and Childs.is_to_comment;`;
            var counts = await osql.connect(count_sql);
            if (counts.length > 0) {
                document.getElementById("replies" + reply_num).innerHTML += `<hr><div id="replier${new_reply_num}"></div><div id="reply-review${new_reply_num}"></div><div id="post-reply${new_reply_num}"><div id="reply-buttons${new_reply_num}" class="my-3"><button type="button" class="btn btn-sm btn-success" onclick="showReplyForm(${object.reply_id}, ${new_reply_num}, true)">返信する</button><button id="reply-select${new_reply_num}" type="button" class="btn btn-sm btn-primary ms-2" onclick="selectReplies(${object.reply_id}, ${new_reply_num})">返信を表示</button></div></div><div id="replies${new_reply_num}" class="ms-5"></div>`;
            } else {
                document.getElementById("replies" + reply_num).innerHTML += `<hr><div id="replier${new_reply_num}"></div><div id="reply-review${new_reply_num}"></div><div id="post-reply${new_reply_num}"><div id="reply-buttons${new_reply_num}" class="my-3"><button type="button" class="btn btn-sm btn-success" onclick="showReplyForm(${object.reply_id}, ${new_reply_num}, false)">返信する</button></div></div><div id="replies${new_reply_num}" class="ms-5"></div>`;
            }
            document.getElementById("replier" + new_reply_num).innerHTML = `<a href="profile.html?userid=${object.replier_id}" class="btn btn-sm btn-outline-dark mt-1 mb-3">${object.name}</a><p class="mb-2">${object.comment}</p>`;
            if (userid === object.replier_id) {
                document.getElementById("replier" + new_reply_num).innerHTML += `<div class="my-3"><button type="button" class="btn btn-sm btn-primary" onclick="editComment('${object.comment}', 'replier' + ${new_reply_num}, ${new_reply_num}, ${object.reply_id})">編集</button><button type="button" class="btn btn-sm btn-danger ms-2" onclick="deleteComment(${object.reply_id})">削除</button></div>`;
            }
            document.getElementById("reply-review" + new_reply_num).innerHTML = `<button type="button" class="btn btn-sm btn-outline-secondary" onclick="doCommentGood(${object.reply_id})">👍</button><span class="ms-2">${object.good}</span><button type="button" class="btn btn-sm btn-outline-secondary ms-4" onclick="doCommentBad(${object.reply_id})">👎</button><span class="ms-2">${object.bad}</span>`;
            document.getElementById("reply-buttons" + reply_num).innerHTML = `<button type="button" class="btn btn-sm btn-success" onclick="showReplyForm(${toid}, ${reply_num}, true)">返信する</button><button id="reply-open${reply_num}" type="button" class="btn btn-sm btn-primary ms-2" style="display: none;" onclick="openReplies(${toid}, ${reply_num})">返信を表示</button><button id="reply-close${reply_num}" type="button" class="btn btn-sm btn-primary ms-2" onclick="closeReplies(${toid}, ${reply_num})">返信を非表示</button>`;

        }
    }


    function closeReplies(toid, reply_num) {
        document.getElementById("reply-buttons" + reply_num).innerHTML = `<button type="button" class="btn btn-sm btn-success" onclick="showReplyForm(${toid}, ${reply_num}, true)">返信する</button><button id="reply-open${reply_num}" type="button" class="btn btn-sm btn-primary ms-2" onclick="openReplies(${toid}, ${reply_num})">返信を表示</button>`;
        document.getElementById("replies" + reply_num).style.display = "none";
    }

    function openReplies(toid, reply_num) {
        document.getElementById("reply-buttons" + reply_num).innerHTML = `<button type="button" class="btn btn-sm btn-success" onclick="showReplyForm(${toid}, ${reply_num}, true)">返信する</button><button id="reply-close${reply_num}" type="button" class="btn btn-sm btn-primary ms-2" onclick="closeReplies(${toid}, ${reply_num})">返信を非表示</button>`;
        document.getElementById("replies" + reply_num).style.display = "block";
    }

    function showReplyForm(toid, num, hasReplies) {
        document.getElementById("post-reply" + num).innerHTML = `<p id="reply-result${num}" class="mt-3"><br></p><div class="mb-3"><input id="input-reply${num}" class="form-control"></input><div class="mt-3"><button type="button" class="btn btn-sm btn-primary" onclick="postReply(${toid}, ${num})">投稿</button> <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="cancelReply(${toid}, ${num}, ${hasReplies})">取消</button></div></div>`;
    }

    async function postReply(toid, num) {
        var userid = sessionStorage.getItem("userid");
        var reply = document.getElementById("input-reply" + num).value;
        var sql = `insert into Comments (userid, comment, toid, is_to_comment) values ("${userid}", "${reply}", ${toid}, true);`;
        if (reply.length > 0) {
            await osql.connect(sql);
            document.getElementById("input-reply" + num).value = "";
            cancelReply(toid, num, true);
            document.getElementById("reply-result" + num).innerHTML = "返信しました";
            document.getElementById("comment-result").innerHTML = "<br>";
        } else {
            document.getElementById("reply-result" + num).innerHTML = `<span class=text-danger>*</span>投稿失敗: 返信内容を入力してください`;
        }
    }

    function cancelReply(comment_id, num, hasReplies) {
        if (hasReplies) {
            document.getElementById("post-reply" + num).innerHTML = `<p id="reply-result${num}" class="mt-3"><br></p><div id="reply-buttons${num}" class="my-3"><button type="button" class="btn btn-sm btn-success" onclick="showReplyForm(${comment_id}, ${num}, true)">返信する</button><button id="reply-select${num}" type="button" class="btn btn-sm btn-primary ms-2" onclick="selectReplies(${comment_id}, ${num})">返信を表示</button></div><div id="replies${num}" class="ms-5"></div>`;
        } else {
            document.getElementById("post-reply" + num).innerHTML = `<p id="reply-result${num}" class="mt-3"><br></p><div id="reply-buttons${num}" class="my-3"><button type="button" class="btn btn-sm btn-success" onclick="showReplyForm(${comment_id}, ${num}, false)">返信する</button></div><div id="replies${num}" class="ms-5"></div>`;
        }
    }

    function editComment(comment, input_id, num, comment_id) {
        var userid = sessionStorage.getItem("userid");
        var username = sessionStorage.getItem("username");
        document.getElementById(input_id).innerHTML = `<div class="mb-3"><a href="profile.html?userid=${userid}" class="btn btn-sm btn-outline-dark mt-1 mb-3">${username}</a><input id="edit-comment${num}" class="form-control" value="${comment}"></input><div class="mt-3"><button type="button" class="btn btn-sm btn-primary" onclick="updateComment('${comment}', '${input_id}', ${num}, ${comment_id})">更新</button><button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="cancelEditComment('${comment}', '${input_id}', ${num}, ${comment_id})">取消</button></div></div>`;
    }

    function cancelEditComment(comment, input_id, num, comment_id) {
        var userid = sessionStorage.getItem("userid");
        var username = sessionStorage.getItem("username");
        document.getElementById(input_id).innerHTML = `<a href="profile.html?userid=${userid}" class="btn btn-sm btn-outline-dark mt-1 mb-3">${username}</a><p class="mb-2">${comment}</p><div class="my-3"><button type="button" class="btn btn-sm btn-primary" onclick="editComment('${comment}', '${input_id}', ${num}, ${comment_id})">編集</button><button type="button" class="btn btn-sm btn-danger ms-2" onclick="deleteComment(${object.comment_id}, true)">削除</button><div>`;
    }

    async function updateComment(comment, input_id, num, comment_id) {
        var userid = sessionStorage.getItem("userid");
        var username = sessionStorage.getItem("username");
        var new_comment = document.getElementById("edit-comment" + num).value;
        var sql = `update Comments set comment = "${new_comment}" where id = ${comment_id};`;
        await osql.connect(sql);
        document.getElementById(input_id).innerHTML = `<a href="profile.html?userid=${userid}" class="btn btn-sm btn-outline-dark mt-1 mb-3">${username}</a><p class="mb-2">${new_comment}</p><div class="my-3"><button type="button" class="btn btn-sm btn-primary" onclick="editComment('${new_comment}', '${input_id}', ${num}, ${comment_id})">編集</button><button type="button" class="btn btn-sm btn-danger ms-2" onclick="deleteComment(${object.comment_id}, true)">削除</button><div>`;
    }

    async function deleteComment(comment_id, is_to_comment) {
        var videoid = osql.getParam("videoid");
        var sql = `delete from Comments where id = ${comment_id};`;
        var isConfirmed = window.confirm("コメントを削除してよろしいですか？");
        if (isConfirmed) {
            document.getElementById("comment-result").innerHTML = "<br>";
            await osql.connect(sql);
            if (!is_to_comment) {
                var count_sql = `select Videos.id from (Videos inner join Users on Videos.userid = Users.id) left join Comments on Videos.id = Comments.toid where Comments.toid = ${videoid} and !is_to_comment;`;
                var counts = await osql.connect(count_sql);
                if (counts.length < 1) {
                    document.getElementById("comment-buttons").innerHTML = "";
                    document.getElementById("comments").innerHTML = "まだコメントはありません"
                } else {
                    selectComments();
                }
            } else {
                selectReplies();
            }
        }
    }

    async function doVideoGood(videoid) {
        var sql = `update Videos set good = good + 1 where id = ${videoid};`;
        await osql.connect(sql);
        location.reload()
    }

    async function undoVideoGood(videoid) {
        var sql = `update Videos set good = good - 1 where id = ${videoid};`;
        await osql.connect(sql);
        location.reload()
    }

    async function doVideoBad(videoid) {
        var sql = `update Videos set bad = bad + 1 where id = ${videoid};`;
        await osql.connect(sql);
        location.reload()
    }

    async function undoVideoBad(videoid) {
        var sql = `update Videos set bad = bad - 1 where id = ${videoid};`;
        await osql.connect(sql);
        location.reload()
    }

    async function doCommentGood(comment_id) {
        var sql = `update Comments set good = good + 1 where id = ${comment_id};`;
        await osql.connect(sql);
        location.reload()
    }

    async function undoCommentGood(comment_id) {
        var sql = `update Comments set good = good - 1 where id = ${comment_id};`;
        await osql.connect(sql);
        location.reload()
    }

    async function doCommentBad(comment_id) {
        var sql = `update Comments set bad = bad + 1 where id = ${comment_id};`;
        await osql.connect(sql);
        location.reload()
    }

    async function undoCommentBad(comment_id) {
        var sql = `update Comments set bad = bad - 1 where id = ${comment_id};`;
        await osql.connect(sql);
        location.reload()
    }
</script>

</html>