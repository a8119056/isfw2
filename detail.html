<!DOCTYPE html>

<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/osql.js"></script>
</head>

<body id="body" class="bg-light">
    <header class="m-3">
        <h1>Ë©≥Á¥∞</h1>
        <div class="m-1">
            <a href="usertop.html" class="btn btn-primary">„Éà„ÉÉ„Éó„Éö„Éº„Ç∏„Å∏</a>
            <a href="javascript:history.back()" class="btn btn-secondary ms-1">„ÇÇ„Å©„Çã</a>
        </div>
    </header>
    <hr>
    <div class="container m-2">
        <div id="video"></div>
        <div id="post-comment" class="mt-4">
            <h3>„Ç≥„É°„É≥„Éà„Åô„Çã</h3>
            <input id="input-comment" type="text" class="form-control"><button type="button" class="btn btn-success mt-3" onclick="postComment()">ÊäïÁ®ø</button>
            <hr>
        </div>
        <div id="comment-buttons"></div>
        <div id="comments"></div>
    </div>
    <hr>
    <footer>
        <div class="text-center p-4">
            <p>&copy; 2021 AEON SOFT Ltd.<br>All rights reserved.</p>
        </div>
    </footer>
</body>

<script>
    $(function() {
        init();
    });

    function init() {
        doSelect();
    }

    osql.requireLogin();

    const reply_nums = [...Array(1024).keys()];

    async function doSelect() {
        var userid = sessionStorage.getItem("userid");
        var videoid = osql.getParam("videoid");
        var sql = `select Videos.id as videoid, userid, url, note, good, bad, name from Videos inner join Users on Videos.userid = Users.id where Videos.id = ${videoid};`;
        var objects = await osql.connect(sql);
        var object = objects[0];
        var count_sql = `select Videos.id from (Videos inner join Users on Videos.userid = Users.id) left join Comments on Videos.id = Comments.toid where Comments.toid = ${videoid} and !is_to_comment;`;
        var counts = await osql.connect(count_sql);
        if (counts.length > 0) {
            document.getElementById("video").innerHTML = `<iframe width='560' height='315' src='https://www.youtube.com/embed/${object.url}' title='YouTube video player' frameborder='0' allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture' allowfullscreen></iframe><p id="user"></p><p id="review"></p>`;
            document.getElementById("comment-buttons").innerHTML = `<button id="comment-close" onclick="closeComments()">„Ç≥„É°„É≥„Éà„ÇíÈùûË°®Á§∫</button><button id="comment-open" onclick="openComments()">„Ç≥„É°„É≥„Éà„ÇíË°®Á§∫</button>`;
            selectComments();
        } else {
            document.getElementById("video").innerHTML = `<iframe width='560' height='315' src='https://www.youtube.com/embed/${object.url}' title='YouTube video player' frameborder='0' allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture' allowfullscreen></iframe><p id="user"></p><p id="review"></p>`;
            document.getElementById("comments").innerHTML = `„Åæ„Å†„Ç≥„É°„É≥„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì`;
        }
        document.getElementById("user").innerHTML = `<a href="profile.html?userid=${object.userid}" class="btn btn-sm btn-outline-dark fs-5 mt-3 mb-2">${object.name}</a><p class="my-3">${object.note}</p>`;
        if (userid === object.userid) {
            document.getElementById("user").innerHTML += `<button type="button" class="btn btn-sm btn-primary" onclick="editNote('${object.note}')">Á∑®ÈõÜ</button>`;
        }
        document.getElementById("review").innerHTML = `<button onclick="doVideoGood(${object.videoid})">üëç</button> ${object.good}    <button onclick="doVideoBad(${object.videoid})">üëé</button> ${object.bad}`;
    }


    function editNote(note) {
        var userid = sessionStorage.getItem("userid");
        var username = sessionStorage.getItem("username");
        document.getElementById("user").innerHTML = `<a href="profile.html?userid=${userid}" class="btn btn-sm btn-outline-dark fs-5 mt-3 mb-2">${username}</a><input id="edit-note" class="form-control mt-2" value="${note}"></input><div class="mt-3"><button type="button" class="btn btn-sm btn-primary" onclick="updateNote()">Êõ¥Êñ∞</button><button type="button" class="btn btn-sm btn-danger ms-1" onclick="cancelEditNote('${note}')">ÂèñÊ∂à</button></div>`;
    }

    function cancelEditNote(note) {
        var userid = sessionStorage.getItem("userid");
        var username = sessionStorage.getItem("username");
        document.getElementById("user").innerHTML = `<a href="profile.html?userid=${userid}" class="btn btn-sm btn-outline-dark fs-5 mt-3 mb-2">${username}</a><p class="my-3">${note}</p><button type="button" class="btn btn-sm btn-primary" onclick="editNote('${note}')">Á∑®ÈõÜ</button>`;
    }

    async function updateNote() {
        var userid = sessionStorage.getItem("userid");
        var username = sessionStorage.getItem("username");
        var videoid = osql.getParam("videoid");
        var new_note = document.getElementById("edit-note").value;
        var sql = `update Videos set note = "${new_note}" where id = ${videoid};`;
        await osql.connect(sql);
        document.getElementById("user").innerHTML = `<a href="profile.html?userid=${userid}" class="btn btn-sm btn-outline-dark fs-5 mt-3 mb-2">${username}</a><p class="my-3">${new_note}</p><button type="button" class="btn btn-sm btn-primary" onclick="editNote('${new_note}')">Á∑®ÈõÜ</button>`;
    }

    async function postComment() {
        var userid = sessionStorage.getItem("userid");
        var videoid = osql.getParam("videoid");
        var comment = document.getElementById("input-comment").value;
        var sql = `insert into Comments (userid, comment, toid, is_to_comment) values ("${userid}", "${comment}", ${videoid}, false);`;
        await osql.connect(sql);
        location.reload();
    }

    async function selectComments() {
        var userid = sessionStorage.getItem("userid");
        var videoid = osql.getParam("videoid");
        var sql = `select Videos.id as video_id, name, Comments.id as comment_id, Comments.userid as commenter_id, comment, Comments.good as good, Comments.bad as bad from (Videos left join Comments on Videos.id = Comments.toid) inner join Users on Comments.userid = Users.id where Comments.toid = ${videoid} and !is_to_comment;`;
        var objects = await osql.connect(sql);
        for (let i = 0; i < objects.length; i++) {
            object = objects[i];
            new_reply_num = reply_nums.shift();
            var count_sql = `select Childs.id from (Comments as Parents left join Comments as Childs on Parents.id = Childs.toid) inner join Users on Childs.userid = Users.id where Childs.toid = ${object.comment_id} and Childs.is_to_comment;`;
            var counts = await osql.connect(count_sql);
            if (counts.length > 0) {
                document.getElementById("comments").innerHTML += `<p id="commenter${i}"></p><p id="comment-review${i}"></p><p id="post-reply${new_reply_num}"><button onclick="showReplyForm(${object.comment_id}, ${new_reply_num})">Ëøî‰ø°„Åô„Çã</button> <button id="reply-btn${new_reply_num}" onclick="selectReplies(${object.comment_id}, ${new_reply_num})">Ëøî‰ø°„ÇíË°®Á§∫</button></p><p id="reply${new_reply_num}" style="margin-left: 40px;"></p>`;
            } else {
                document.getElementById("comments").innerHTML += `<p id="commenter${i}"></p><p id="comment-review${i}"></p><p id="post-reply${new_reply_num}"><button onclick="showReplyForm(${object.comment_id}, ${new_reply_num})">Ëøî‰ø°„Åô„Çã</button></p><p id="reply${new_reply_num}" style="margin-left: 40px;"></p>`;
            }
            document.getElementById("commenter" + i).innerHTML = `<b>${object.name}</b> ${object.comment}`;
            if (userid === object.commenter_id) {
                document.getElementById("commenter" + i).innerHTML += ` <button onclick="editComment('${object.comment}', 'commenter' + ${i}, ${new_reply_num}, ${object.comment_id})">Á∑®ÈõÜ</button> <button onclick="deleteComment(${object.comment_id})">ÂâäÈô§</button>`;
            }
            document.getElementById("comment-review" + i).innerHTML = `<button onclick="doCommentGood(${object.comment_id})">üëç</button> ${object.good}    <button onclick="doCommentBad(${object.comment_id})">üëé</button> ${object.bad}`;
        }
        document.getElementById("comment-open").style.display = "none";
    }


    function closeComments() {
        document.getElementById("comment-open").style.display = "block";
        document.getElementById("comment-close").style.display = "none";
        document.getElementById("comments").style.display = "none";
    }

    function openComments() {
        document.getElementById("comment-open").style.display = "none";
        document.getElementById("comment-close").style.display = "block";
        document.getElementById("comments").style.display = "block";
    }


    async function selectReplies(toid, reply_num) {
        var userid = sessionStorage.getItem("userid");
        var sql = `select name, Childs.userid as replier_id, Childs.id as reply_id, Childs.comment as comment, Childs.good as good, Childs.bad as bad from (Comments as Parents left join Comments as Childs on Parents.id = Childs.toid) inner join Users on Childs.userid = Users.id where Childs.toid = ${toid} and Childs.is_to_comment;`;
        var objects = await osql.connect(sql);
        for (let i = 0; i < objects.length; i++) {
            object = objects[i];
            new_reply_num = reply_nums.shift();
            var count_sql = `select Childs.id from (Comments as Parents inner join Users on Parents.userid = Users.id) left join Comments as Childs on Parents.id = Childs.toid where Childs.toid = ${object.reply_id} and Childs.is_to_comment;`;
            var counts = await osql.connect(count_sql);
            if (counts.length > 0) {
                document.getElementById("reply" + reply_num).innerHTML += `<p id="replier${new_reply_num}"></p><p id="reply-review${new_reply_num}"></p><p id="post-reply${new_reply_num}"><button onclick="showReplyForm(${object.reply_id}, ${new_reply_num})">Ëøî‰ø°„Åô„Çã</button> <button id="reply-btn${new_reply_num}" onclick="selectReplies(${object.reply_id}, ${new_reply_num})">Ëøî‰ø°„ÇíË°®Á§∫</button></p><p id="reply${new_reply_num}" style="margin-left: 40px;"></p>`;
            } else {
                document.getElementById("reply" + reply_num).innerHTML += `<p id="replier${new_reply_num}"></p><p id="reply-review${new_reply_num}"></p><p id="post-reply${new_reply_num}"><button onclick="showReplyForm(${object.reply_id}, ${new_reply_num})">Ëøî‰ø°„Åô„Çã</button></p><p id="reply${new_reply_num}" style="margin-left: 40px;"></p>`;
            }
            document.getElementById("replier" + new_reply_num).innerHTML = `<b>${object.name}</b> ${object.comment}`;
            if (userid === object.replier_id) {
                document.getElementById("replier" + new_reply_num).innerHTML += ` <button onclick="editComment('${object.comment}', 'replier' + ${new_reply_num}, ${new_reply_num}, ${object.reply_id})">Á∑®ÈõÜ</button> <button onclick="deleteComment(${object.reply_id})">ÂâäÈô§</button>`;
            }
            document.getElementById("reply-review" + new_reply_num).innerHTML = `<button onclick="doCommentGood(${object.reply_id})">üëç</button> ${object.good}    <button onclick="doCommentBad(${object.reply_id})">üëé</button> ${object.bad}`;
        }
        document.getElementById("reply-btn" + reply_num).innerHTML = "Ëøî‰ø°„ÇíÈùûË°®Á§∫";
        $("#reply-btn" + reply_num).removeAttr("onclick");
        $("#reply-btn" + reply_num).on("click", function() {
            closeReplies(reply_num);
        });
    }


    function closeReplies(reply_num) {
        document.getElementById("reply" + reply_num).style.display = "none";
        document.getElementById("reply-btn" + reply_num).innerHTML = "Ëøî‰ø°„ÇíË°®Á§∫";
        $("#reply-btn" + reply_num).removeAttr("onclick");
        $("#reply-btn" + reply_num).on("click", function() {
            openReplies(reply_num);
        });
    }

    function openReplies(reply_num) {
        document.getElementById("reply" + reply_num).style.display = "block";
        document.getElementById("reply-btn" + reply_num).innerHTML = "Ëøî‰ø°„ÇíÈùûË°®Á§∫";
        $("#reply-btn" + reply_num).removeAttr("onclick");
        $("#reply-btn" + reply_num).on("click", function() {
            closeReplies(reply_num);
        });
    }

    function showReplyForm(toid, num) {
        document.getElementById("post-reply" + num).innerHTML = `<input id="input-reply${num}" type="text"></input> <button onclick="postReply(${toid}, ${num})">ÊäïÁ®ø</button> <button onclick="cancelReply(${toid}, ${num})">ÂèñÊ∂à</button>`;
    }

    async function postReply(toid, num) {
        var userid = sessionStorage.getItem("userid");
        var reply = document.getElementById("input-reply" + num).value;
        var sql = `insert into Comments (userid, comment, toid, is_to_comment) values ("${userid}", "${reply}", ${toid}, true);`;
        await osql.connect(sql);
        location.reload()
    }

    function cancelReply(comment_id, num) {
        document.getElementById("post-reply" + num).innerHTML = `<p id="post-reply${num}"><button onclick="showReplyForm(${comment_id}, ${num})">Ëøî‰ø°„Åô„Çã</button> <button id="reply-btn${new_reply_num}" onclick="selectReplies(${comment_id}, ${num})">Ëøî‰ø°„ÇíË°®Á§∫</button></p><p id="reply${num}" style="margin-left: 40px;"></p>`;
    }

    function editComment(comment, input_id, num, comment_id) {
        var username = sessionStorage.getItem("username");
        document.getElementById(input_id).innerHTML = `<b>${username}</b> <input id="edit-comment${num}" value="${comment}"></input> <button onclick="updateComment('${comment}', '${input_id}', ${num}, ${comment_id})">Êõ¥Êñ∞</button> <button onclick="cancelEditComment('${comment}', '${input_id}', ${num}, ${comment_id})">ÂèñÊ∂à</button>`;
    }

    function cancelEditComment(comment, input_id, num, comment_id) {
        var username = sessionStorage.getItem("username");
        document.getElementById(input_id).innerHTML = `<b>${username}</b> ${comment} <button onclick="editComment('${comment}', '${input_id}', ${num}, ${comment_id})">Á∑®ÈõÜ</button>`;
    }

    async function updateComment(comment, input_id, num, comment_id) {
        var username = sessionStorage.getItem("username");
        var new_comment = document.getElementById("edit-comment" + num).value;
        var sql = `update Comments set comment = "${new_comment}" where id = ${comment_id};`;
        await osql.connect(sql);
        document.getElementById(input_id).innerHTML = `<b>${username}</b> ${new_comment} <button onclick="editComment('${new_comment}', '${input_id}', ${num}, ${comment_id})">Á∑®ÈõÜ</button>`;
    }

    async function deleteComment(comment_id) {
        var sql = `delete from Comments where id = ${comment_id};`;
        var isConfirmed = window.confirm("„Ç≥„É°„É≥„Éà„ÇíÂâäÈô§„Åó„Å¶„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü");
        if (isConfirmed) {
            await osql.connect(sql);
            location.reload()
        }
    }


    async function doVideoGood(videoid) {
        var sql = `update Videos set good = good + 1 where id = ${videoid};`;
        await osql.connect(sql);
        location.reload()
    }

    async function undoVideoGood(videoid) {
        var sql = `update Videos set good = good - 1 where id = ${videoid};`;
        await osql.connect(sql);
        location.reload()
    }

    async function doVideoBad(videoid) {
        var sql = `update Videos set bad = bad + 1 where id = ${videoid};`;
        await osql.connect(sql);
        location.reload()
    }

    async function undoVideoBad(videoid) {
        var sql = `update Videos set bad = bad - 1 where id = ${videoid};`;
        await osql.connect(sql);
        location.reload()
    }

    async function doCommentGood(comment_id) {
        var sql = `update Comments set good = good + 1 where id = ${comment_id};`;
        await osql.connect(sql);
        location.reload()
    }

    async function undoCommentGood(comment_id) {
        var sql = `update Comments set good = good - 1 where id = ${comment_id};`;
        await osql.connect(sql);
        location.reload()
    }

    async function doCommentBad(comment_id) {
        var sql = `update Comments set bad = bad + 1 where id = ${comment_id};`;
        await osql.connect(sql);
        location.reload()
    }

    async function undoCommentBad(comment_id) {
        var sql = `update Comments set bad = bad - 1 where id = ${comment_id};`;
        await osql.connect(sql);
        location.reload()
    }
</script>

</html>